
    <div id="main" role="main">
        <div id="post" class="content" itemscope="" itemtype="http://schema.org/Article">
            <h1 itemprop="name">Eliminating Roundtrips with Preconnect</h1>
            <p class="byline">By <a href="https://www.igvita.com/" rel="author" itemprop="author">Ilya Grigorik</a> on <b itemprop="datePublished" datetime="2015-08-17">August 17, 2015</b></p>
            <p>The "simple" act of initiating an HTTP request can incur many roundtrips before the actual request bytes are routed to the server: the browser may have to resolve the DNS name, perform the TCP handshake, and negotiate the TLS tunnel if a secure socket is required. All accounted for, that's anywhere from one to three — and more in unoptimized cases — roundtrips of latency to set up the socket before the actual request bytes are routed to the server.</p>
            <p><img src="./Eliminating-Roundtrips-with-Preconnect_igvita.com_files/xsocket-setup.png.pagespeed.ic.tcdxXJS0lbWTE4TOlVtK.png" class="center" style="max-width:770px;width:100%"></p>
            <p>Modern browsers <a href="https://www.igvita.com/posa/high-performance-networking-in-google-chrome/#tcp-pre-connect">try their best to anticipate</a> what connections the site will need before the actual request is made. By initiating early <em>"preconnects"</em>, the browser can set up the necessary sockets ahead of time and eliminate the costly DNS, TCP, and TLS roundtrips from the critical path of the actual request. That said, as smart as modern browsers are, they cannot reliably predict all the preconnect targets for each and every website.</p>
            <p><strong>The good news is that we can — finally — help the browser; we can tell the browser which sockets we will need ahead of initiating the actual requests via the new <a href="http://w3c.github.io/resource-hints/#preconnect">preconnect hint</a> shipping in <a href="https://developer.mozilla.org/en-US/Firefox/Releases/39#HTML">Firefox 39</a> and <a href="https://www.chromestatus.com/feature/5560623895150592">Chrome 46</a>!</strong> Let's take a look at some hands-on examples of how and where you might want to use it.</p>
            <h2>Preconnect for dynamic request URLs</h2>
            <p>Your application may not know the full resource URL ahead of time due to conditional loading logic, UA adaptation, or other reasons. However, if the origin from which the resources are going to be fetched is known, then a preconnect hint is a perfect fit. Consider the following example with Google Fonts, both with and without the preconnect hint:</p>
            <p><img src="./Eliminating-Roundtrips-with-Preconnect_igvita.com_files/xfont-preconnect.png.pagespeed.ic.tC0wdnTl8DuD8UE7Xn1Y.png" class="center" style="max-width:770px;width:100%"></p>
            <p>In the <a href="https://output.jsbin.com/dacihe/quiet">first trace</a>, the browser fetches the HTML and discovers that it needs a CSS resource residing on <code>fonts.googleapis.com</code>. With that downloaded it <a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/constructing-the-object-model?hl=en">builds the CSSOM</a>, determines that the page will need two fonts, and initiates requests for each from <code>fonts.gstatic.com</code> — first though, it needs to perform the DNS, TCP, and TLS handshakes with that origin, and once the socket is ready both requests are multiplexed over the HTTP/2 connection.</p>
            <div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">'https://fonts.gstatic.com'</span> <span class="na">rel=</span><span class="s">'preconnect'</span> <span class="na">crossorigin</span><span class="nt">&gt;</span>
                <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">'https://fonts.googleapis.com/css?family=Roboto+Slab:700|Open+Sans'</span> <span class="na">rel=</span><span class="s">'stylesheet'</span><span class="nt">&gt;</span></code></pre></div>
            <p>In the <a href="https://output.jsbin.com/pocima/1/quiet">second trace</a>, we add the <em>preconnect hint</em> in our markup indicating that the application will fetch resources from <code>fonts.gstatic.com</code>. <strong>As a result, the browser begins the socket setup in parallel with the CSS request, completes it ahead of time, and allows the font requests to be sent immediately!</strong> In this particular scenario, preconnect removes three RTTs from the critical path and eliminates over half of second of latency.</p>
            <div class="callout">
                The <a href="http://www.w3.org/TR/css3-fonts/#font-fetching-requirements">font-face specification requires</a> that fonts are loaded in "anonymous mode", which is why we must provide the <code>crossorigin</code> attribute on the preconnect hint: the browser maintains a separate pool of sockets for this mode.
            </div>
            <h2>Initiating preconnect via Link HTTP header</h2>
            <p>In addition to declaring the preconnect hints via HTML markup, we can also deliver them via an HTTP <code>Link</code> header. For example, to achieve <a href="http://www.webpagetest.org/result/150812_9H_10VA/1/details/">the same preconnect benefits</a> as above, the server could have delivered the preconnect hint without modifying the page markup - see below. <strong>The <code>Link</code> header mechanism allows <em>each response</em> to indicate to the browser which other origins it should connect to ahead of time.</strong> For example, included widgets and dependencies can help optimize performance by indicating which other origins they will need, and so on.</p>
            <p><img src="./Eliminating-Roundtrips-with-Preconnect_igvita.com_files/xpreconnect-header.png.pagespeed.ic.BLSb9xDHau48jy0_DvDO.png" class="center" style="max-width:770px;width:100%"></p>
            <h2>Preconnect with JavaScript</h2>
            <p>We don't have to declare all preconnect origins upfront. <strong>The application can invoke preconnects in response to user input, anticipated activity, or other user signals with the help of JavaScript.</strong> For example, consider the case where an application anticipates the likely navigation target and issues an early preconnect:</p>
            <div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">preconnectTo</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">hint</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"link"</span><span class="p">);</span>
                <span class="nx">hint</span><span class="p">.</span><span class="nx">rel</span> <span class="o">=</span> <span class="s2">"preconnect"</span><span class="p">;</span>
                <span class="nx">hint</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">hint</span><span class="p">);</span>
                <span class="p">}</span></code></pre></div>
            <p><img src="./Eliminating-Roundtrips-with-Preconnect_igvita.com_files/xreactive-preconnect.png.pagespeed.ic.RRrQofs6kRlvTwOxOjp_.png" class="center" style="max-width:770px;width:100%"></p>
            <p>The user starts on <code>jsbin.com</code>; at ~3.0 second mark the page determines that the user might be navigating to <code>engineering.linkedin.com</code> and initiates a preconnect for that origin; at ~5.0 second mark the user initiates the navigation, and the request is dispatched without blocking on DNS, TCP, or TLS handshakes — nearly a second saved for the navigation!</p>
            <h2>Preconnect often, Preconnect wisely</h2>
            <p>Preconnect is an important tool in your optimization toolbox. As above examples illustrate, it can eliminate many costly roundtrips from your request path — in some cases reducing the request latency by hundreds and even thousands of milliseconds. That said, use it wisely: <strong>each open socket incurs costs both on the client and server, and you want to avoid opening sockets that might go unused.</strong> As always, apply, measure real-world impact, and iterate to get the best performance mileage from this feature.</p>
            <p>Finally, for debugging purposes, do note that preconnect directives are treated as <em>optimization hints:</em> the browser might not act on each directive each and every time, and the browser is allowed to adjust its logic to perform a partial handshake - e.g. fall back to DNS lookup only, or DNS+TCP for TLS connections.</p>
            <div class="author-callout">
                <img src="./Eliminating-Roundtrips-with-Preconnect_igvita.com_files/35x35xigrigorik-small.png.pagespeed.ic.FmehiWX7chFeey2eSwws.webp" alt="Ilya Grigorik" height="35px" width="35px"><strong>Ilya Grigorik</strong> is a web performance engineer at Google, co-chair of the W3C Web Performance working group, and author of High Performance Browser Networking (O'Reilly) book — follow on <a href="https://twitter.com/igrigorik">Twitter</a>, <a href="https://plus.google.com/+IlyaGrigorik">Google+</a>.
            </div>
            <div class="content social">
                <a href="https://www.igvita.com/2015/08/17/eliminating-roundtrips-with-preconnect/#disqus_thread" onclick="return loadDisqus()">View comments (30)</a>, share on <a href="https://twitter.com/share?url=https://www.igvita.com/2015/08/17/eliminating-roundtrips-with-preconnect/&amp;text=Eliminating%20Roundtrips%20with%20Preconnect:&amp;via=igrigorik" target="_blank">Twitter</a><span id="twittercount"></span>, <a href="https://plus.google.com/share?url=https://www.igvita.com/2015/08/17/eliminating-roundtrips-with-preconnect/" target="_blank">Google+</a><span id="gpluscount"> (303)</span><span id="fbcount">, <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.igvita.com/2015/08/17/eliminating-roundtrips-with-preconnect/" target="_blank">Facebook</a> (150)</span>.
            </div>
        </div>
        <div id="comments" class="content">
            <div id="disqus_thread"></div>
        </div>
    </div>
    <div id="meta">
        <div class="group book">
            <div class="book-cover" style="margin-top:0.2em"></div>
            <h3 style="color: #fff">High-Performance Browser Networking (O'Reilly)</h3>
            <p style="font-style:italic">What every web developer must know about networking and browser performance: impact of latency and bandwidth, TCP, UDP, and TLS optimization, performance tips for mobile networks, and an under the hood look at performance of HTTP 1.1/2.0, XMLHttpRequest, WebSocket, WebRTC, DataChannel, and other transports.</p>
            <p style="padding-top:0.5em"><a href="http://chimera.labs.oreilly.com/books/1230000000545?utm_source=igvita&amp;utm_medium=referral&amp;utm_campaign=igvita-footer" style="text-decoration:none;"><span class="button">Read Online for Free</span></a></p>
        </div>
    </div>

    <script>
//        var disqus_url='https://www.igvita.com/2015/08/17/eliminating-roundtrips-with-preconnect/';
//        var disqus_shortname='igvita';
//        var loadDisqus=function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//igvita.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);return false;};function social_counts(data){var twc=document.getElementById('twittercount'),gwc=document.getElementById('gpluscount'),fwc=document.getElementById('fbcount');if(data['Twitter']>0){twc.innerText=' ('+data['Twitter']+')'}if(data['GooglePlusOne']>0){gwc.innerText=' ('+data['GooglePlusOne']+')'}if(data['Facebook']['total_count']>0){fwc.innerHTML=", <a href='https://www.facebook.com/sharer/sharer.php?u=https://www.igvita.com/2015/08/17/eliminating-roundtrips-with-preconnect/' target='_blank'>Facebook</a>"+' ('+data['Facebook']['total_count']+')';}}
//        var scount=document.createElement('script');scount.src="//free.sharedcount.com/?callback=social_counts&url=https://www.igvita.com/2015/08/17/eliminating-roundtrips-with-preconnect/&apikey=3e1fc0ba6af5530d504d4cc95d73309978520066"
//        document.getElementsByTagName('head')[0].appendChild(scount);
    </script>

    <script src="https://a.disquscdn.com/count.js" async=""></script>
    <footer>
        <div id="copyright">
            <div class="group">
                <span>© 2005-2016 Ilya Grigorik</span>
                <a href="https://www.igvita.com/" class="about">about</a><a href="http://feeds.igvita.com/igvita" class="about rss">subscribe via rss</a>
            </div>
        </div>
    </footer>
</div> <!-- end of #container -->
<noscript class="psa_add_styles">&lt;link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:400,700"&gt;&lt;link rel="stylesheet" href="https://1-ps.googleusercontent.com/sk/bYSmB63yuhjL_l7bPRuu4R3ENi/www.igvita.com/css/A.style.css+monokai.css,Mcc.qeEuaFE_7Oo9zp2Ysbfz.css.pagespeed.cf.zzTRgUQaokD4E6yp-GfF.css"&gt;</noscript><script data-pagespeed-no-defer="">(function(){function b(){var a=window,c=e;if(a.addEventListener)a.addEventListener("load",c,!1);else if(a.attachEvent)a.attachEvent("onload",c);else{var d=a.onload;a.onload=function(){c.call(this);d&&d.call(this)}}};var f=!1;function e(){if(!f){f=!0;for(var a=document.getElementsByClassName("psa_add_styles"),c=0,d;d=a[c];++c)if("NOSCRIPT"==d.nodeName){var k=document.createElement("div");k.innerHTML=d.textContent;document.body.appendChild(k)}}}function g(){var a=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null;a?a(function(){window.setTimeout(e,0)}):b()}
    var h=["pagespeed","CriticalCssLoader","Run"],l=this;h[0]in l||!l.execScript||l.execScript("var "+h[0]);for(var m;h.length&&(m=h.shift());)h.length||void 0===g?l=l[m]?l[m]:l[m]={}:l[m]=g;})();
pagespeed.CriticalCssLoader.Run();</script><script data-pagespeed-no-defer="">(function(){window.pagespeed=window.pagespeed||{};var l=window.pagespeed;
    l.getResourceTimingData=function(){if(window.performance&&(window.performance.getEntries||window.performance.webkitGetEntries)){for(var m=0,n=0,e=0,p=0,f=0,q=0,g=0,r=0,h=0,t=0,k=0,c={},d=window.performance.getEntries?window.performance.getEntries():window.performance.webkitGetEntries(),b=0;b<d.length;b++){var a=d[b].duration;0<a&&(m+=a,++e,n=Math.max(n,a));a=d[b].connectEnd-d[b].connectStart;0<a&&(q+=a,++g);a=d[b].domainLookupEnd-d[b].domainLookupStart;0<a&&(p+=a,++f);a=d[b].initiatorType;c[a]?++c[a]:
            c[a]=1;a=d[b].requestStart-d[b].fetchStart;0<a&&(t+=a,++k);a=d[b].responseStart-d[b].requestStart;0<a&&(r+=a,++h)}return"&afd="+(e?Math.round(m/e):0)+"&nfd="+e+"&mfd="+Math.round(n)+"&act="+(g?Math.round(q/g):0)+"&nct="+g+"&adt="+(f?Math.round(p/f):0)+"&ndt="+f+"&abt="+(k?Math.round(t/k):0)+"&nbt="+k+"&attfb="+(h?Math.round(r/h):0)+"&nttfb="+h+(c.css?"&rit_css="+c.css:"")+(c.link?"&rit_link="+c.link:"")+(c.script?"&rit_script="+c.script:"")+(c.img?"&rit_img="+c.img:"")}return""};
    l.getResourceTimingData=l.getResourceTimingData;})();
(function(){window.pagespeed=window.pagespeed||{};var e=window.pagespeed;function g(a,c,b,d){this.f=a;this.a=c;this.b=b;this.g=d}e.beaconUrl="";
    g.prototype.sendBeacon=function(){var a=this.f,c=window.mod_pagespeed_start,b=Number(new Date)-c,a=a+(-1==a.indexOf("?")?"?":"&"),a=a+"ets="+("load"==this.a?"load:":"unload:"),a=a+b;if("beforeunload"!=this.a||!window.mod_pagespeed_loaded){a+="&r"+this.a+"=";if(window.performance){var b=window.performance.timing,d=b.navigationStart,f=b.requestStart,a=a+(b[this.a+"EventStart"]-d),a=a+("&nav="+(b.fetchStart-d)),a=a+("&dns="+(b.domainLookupEnd-b.domainLookupStart)),a=a+("&connect="+(b.connectEnd-b.connectStart)),
            a=a+("&req_start="+(f-d)),a=a+("&ttfb="+(b.responseStart-f)),a=a+("&dwld="+(b.responseEnd-b.responseStart)),a=a+("&dom_c="+(b.domContentLoadedEventStart-d));window.performance.navigation&&(a+="&nt="+window.performance.navigation.type);d=-1;b.msFirstPaint?d=b.msFirstPaint:window.chrome&&window.chrome.loadTimes&&(d=Math.floor(1E3*window.chrome.loadTimes().firstPaintTime));d-=f;0<=d&&(a+="&fp="+d)}else a+=b;e.getResourceTimingData&&window.parent==window&&(a+=e.getResourceTimingData());a+=window.parent!=
    window?"&ifr=1":"&ifr=0";"load"==this.a&&(window.mod_pagespeed_loaded=!0,(b=window.mod_pagespeed_num_resources_prefetched)&&(a+="&nrp="+b),(b=window.mod_pagespeed_prefetch_start)&&(a+="&htmlAt="+(c-b)));e.panelLoader&&(c=e.panelLoader.getCsiTimingsString(),""!=c&&(a+="&b_csi="+c));e.criticalCss&&(c=e.criticalCss,a+="&ccis="+c.total_critical_inlined_size+"&cces="+c.total_original_external_size+"&ccos="+c.total_overhead_size+"&ccrl="+c.num_replaced_links+"&ccul="+c.num_unreplaced_links);a+="&dpr="+
            window.devicePixelRatio;""!=this.b&&(a+=this.b);document.referrer&&(a+="&ref="+encodeURIComponent(document.referrer));a+="&url="+encodeURIComponent(this.g);e.beaconUrl=a;(new Image).src=a}};e.c=function(a,c,b,d){var f=new g(a,c,b,d);window.addEventListener?window.addEventListener(c,function(){f.sendBeacon()},!1):window.attachEvent("on"+c,function(){f.sendBeacon()})};e.addInstrumentationInit=e.c;})();

//pagespeed.addInstrumentationInit('https://1-ps.googleusercontent.com/beacon?org=175_1_vf', 'load', '&id=1456089878429507', 'https://www.igvita.com/2015/08/17/eliminating-roundtrips-with-preconnect/');
    </script>

<div><link rel="stylesheet" href="./Eliminating-Roundtrips-with-Preconnect_igvita.com_files/css.css"><link rel="stylesheet" href="./Eliminating-Roundtrips-with-Preconnect_igvita.com_files/A.style.css+monokai.css,Mcc.qeEuaFE_7Oo9zp2Ysbfz.css.pagespeed.cf.zzTRgUQaokD4E6yp-GfF.css"></div>

</body>
</html>